# Core v5.7.1

**Release Date:** November 26, 2024
**Tags:** BUG FIXES, BINARY OPTIONS, P2P TRADING

## Fixed

### Binary Options Trading

- **Investment Return on Wins**: Fixed critical issue where winning trades only returned profit without the original investment
  - Users were losing their investment amount on every winning trade
  - Example: $100 investment with 87% profit should return $187, but only returned $87
  - Balance calculations now correctly return investment + profit on winning trades
  - Applies to all trading modes (demo and real)

- **Profit Percentage Configuration**: Fixed hardcoded 88% profit being used instead of configured duration-specific percentages
  - System was ignoring admin-configured profit percentages in binary_duration table
  - All durations showed 88% profit regardless of settings
  - Profit percentages now dynamically loaded from database per duration
  - Admins can now customize profit percentages for each time duration (1min, 5min, 15min, etc.)
  - Profit percentage properly stored with each order for historical accuracy

### P2P Trading

- **Database Schema**: Fixed "Can't create table p2p_trades (errno: 150 'Foreign key constraint is incorrectly formed')" error
  - Root cause: Type mismatch between paymentMethod field (VARCHAR) and payment method ID reference (UUID)
  - Updated paymentMethod field to use UUID type for proper foreign key constraint
  - Enables proper relationship between trades and payment methods

- **Currency Display**: Fixed all P2P trades showing USD ($) instead of the actual trading currency
  - Trade listings now display correct currency symbols (€, £, etc.)
  - Trade details pages show accurate currency symbols
  - Escrow information displays proper currency formatting
  - Payment instructions use the correct currency symbol

- **Trade Status Handling**: Fixed critical status mismatch causing buttons to not appear or work correctly
  - Backend uses uppercase statuses (PENDING, PAYMENT_SENT, COMPLETED)
  - Frontend was checking lowercase variations (waiting_payment, payment_confirmed)
  - Created status normalization utility to handle all status variations
  - Buttons now appear and function correctly based on trade state
  - Status displays are now consistent across all components

- **Chat System Improvements**:
  - Fixed chat window flickering during message polling
  - Fixed input field losing focus after typing or sending messages
  - Added file attachment functionality (documents and images)
  - Improved message polling to only update when new messages arrive
  - Better focus management for seamless typing experience
  - File upload support for payment receipts and screenshots

- **Admin Panel Fixes**:
  - Fixed 404 errors when viewing trade details
  - Corrected API endpoint paths for admin trade management
  - Added missing offer action endpoints (reject, flag, disable)
  - Fixed breadcrumb navigation in admin trade details
  - Admin can now properly disable, remove, and flag offers
  - All admin actions now log properly for audit trail

## Migration Notes

### Database Migration Required

**IMPORTANT**: This update requires dropping and recreating the `p2p_trades` table due to schema changes.

**Steps to perform migration:**

1. **Backup your database** before proceeding
2. Run the following SQL commands (or use phpMyAdmin):
   ```sql
   SET FOREIGN_KEY_CHECKS = 0;
   DROP TABLE IF EXISTS `p2p_trades`;
   SET FOREIGN_KEY_CHECKS = 1;
   ```
3. **Alternative (phpMyAdmin)**:
   - Open phpMyAdmin and select your database
   - Find the `p2p_trades` table in the table list and click "Drop"
   - When the confirmation dialog appears, **uncheck the "Enable foreign key checks" checkbox**
   - Click "Yes" to confirm the drop operation
   - Repeat for `p2p_disputes` and `p2p_reviews` tables
4. Restart your backend application
5. The tables will be recreated automatically with the correct schema

**Note**: This migration will delete all existing P2P trades, disputes, and reviews.