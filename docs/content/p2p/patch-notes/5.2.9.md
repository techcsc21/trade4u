# P2P v5.2.9

**Release Date:** November 29, 2025
**Tags:** FEATURES, BUG FIXES, ADMIN DASHBOARD, NOTIFICATIONS, VALIDATION

## Added

### Counterparty Statistics

- **Real-time User Statistics**: Users can now see detailed trading statistics for their counterparties
  - Total completed trades count for each user
  - Completion rate percentage showing reliability
  - Helps assess counterparty trustworthiness before trading
  - Statistics calculated dynamically from actual trade history
  - Displayed for both buyer and seller in trade details

## Improved

### Documentation

- **Email Integration Ready**: Email notification infrastructure prepared for future activation
  - Clear integration points for P2P trade notifications
  - Example implementation patterns included in code
  - Ready for email service integration when needed

## Fixed

### Admin Dashboard

- **Timeline Tab**: Fixed "No timeline events available" error when viewing trade timeline
  - Timeline now properly displays all trade lifecycle events
  - Events shown chronologically with correct timestamps
  - Proper formatting for event details and descriptions

- **Messages Tab**: Fixed empty messages tab not showing user chat messages
  - Chat messages now properly extracted from trade timeline
  - Sender information (name, avatar) displayed correctly
  - Visual distinction between admin and user messages
  - Admin messages appear in user chats with admin badge

- **Admin Message Sending**: Enhanced admin note system to support both notes and messages
  - Added ability to send messages visible to users
  - Internal notes remain private to admins only
  - Both participants notified when admin sends a message
  - Clear distinction between notes and messages in interface

- **Admin Actions**: Fixed all admin action buttons
  - Cancel Trade button now works correctly
  - Resolve for Buyer/Seller buttons function properly
  - Flag for Review and Message Participants buttons operational
  - All trade management actions now successful

- **Trade Notes**: Implemented note adding functionality
  - Admin notes stored in trade timeline with admin name and timestamp
  - Notes displayed in sidebar for quick reference
  - Proper audit trail for admin activities

- **Admin Interface Cleanup**: Removed hardcoded placeholder data
  - Eliminated test trade IDs from Related Trades section
  - Cleaner, more professional admin interface

- **Offer Disable Error**: Fixed "Data truncated for column 'status'" error
  - Offer disable/delete functionality now works correctly
  - Proper status transitions implemented

- **Offer Notes**: Created admin offer note system
  - Admins can add timestamped notes to offers
  - View complete note history for each offer
  - Admin activities tracked in activity log
  - Notes include admin name and timestamp for audit trail

### Trade Timeout & Expiry

- **Trade Timeout Enforcement**: Automatic trade expiration system implemented
  - Cron job runs every 5 minutes to check for expired trades
  - Trade status automatically updated to "EXPIRED"
  - Escrowed funds released back to seller's wallet
  - Amount restored to original offer if still active
  - Timeline event added with expiry notification
  - Both participants notified of expiration

- **Manual Timeout Trigger**: Added admin endpoint for manual timeout processing
  - Admins can manually trigger trade timeout when needed
  - Requires proper P2P management permissions

### Fee Calculation

- **Taker Fee Assignment**: Fixed incorrect fee calculation for trade initiators
  - Trade initiators now correctly identified as "takers"
  - Taker fee always applied to trade initiators
  - Proper fee assignment regardless of buy/sell direction

- **Currency Display**: Fixed hardcoded USD fallback in fee calculations
  - System now properly checks offer and price configuration currencies
  - Correct currency display across all price currencies
  - Accurate fee amounts shown in proper currency

### Trade Amount Validation

- **Currency-Specific Minimums**: Added enforcement of minimum trade amounts per currency
  - Prevents crypto dust issues (e.g., BTC minimum: 0.00005)
  - Minimums validated during offer creation, updates, and trade initiation
  - Helps avoid blockchain UTXO consolidation problems

- **Platform Min/Max Limits**: Added enforcement of global trade limits
  - Platform-wide minimum and maximum amounts validated
  - Limits checked during offer creation and updates
  - Trade amounts validated against platform settings
  - Clear error messages showing violated limits and requirements

### Offer Creation

- **Fee Display**: Fixed fee section appearing when platform fees are 0%
  - Fee section only shown when there's an actual fee to display
  - Cleaner interface when fees are disabled

- **Balance Requirement**: Fixed "Insufficient balance" error when creating SELL offers
  - Can now create offer first and fund it later
  - Balance only locked when someone initiates a trade
  - More flexible offer creation workflow

- **KYC Default**: Changed KYC verification to be disabled by default
  - Can still enable KYC requirement if needed
  - No longer need to manually disable it every time
  - Faster offer creation process

### Trade Dashboard & Details

- **Currency Display**: Fixed currency symbols throughout trade interface
  - Escrow fee shows correct currency (e.g., "0.1 BTC (â‚¬100)" instead of "$100")
  - Payment amounts use trade's actual currency
  - Trade overview displays proper currency symbols
  - All amounts match offer's pricing currency

- **Payment Method Display**: Fixed payment method showing alphanumeric ID
  - Now displays readable payment method name (e.g., "Bank Transfer")
  - Better user experience with clear payment instructions

- **Expired Trades Visibility**: Fixed expired trades appearing in active trades list
  - Expired trades properly excluded from active dashboard
  - Marked as final status (no actions possible)
  - No longer prevent offer deletion

- **Offer Deletion**: Fixed offers blocked from deletion due to expired trades
  - Offers can now be deleted if all trades are in final states
  - Final states: COMPLETED, CANCELLED, DISPUTED, or EXPIRED

### Dispute System

- **Dispute Dialog**: Created proper dispute dialog with reason selection
  - Valid dispute reasons available: Payment Not Received, Incorrect Amount, Unresponsive Party, Fraudulent Activity, Terms Violation, Other
  - Clear descriptions for each reason option
  - Detailed explanation field (20-1000 characters)
  - Important warnings about dispute process displayed

- **Reason Validation**: Fixed "Invalid request body" error when opening disputes
  - Proper uppercase reason values sent to backend
  - Validation errors eliminated

### Notifications

- **Notification Type Fix**: Fixed "Invalid notification type" validation error
  - Proper notification types used throughout P2P system
  - Notifications now created successfully

- **Admin Message Notifications**: Added support for admin message notifications
  - Both buyer and seller receive notifications
  - Clear notification title: "Message from Admin"
  - Includes admin's message content
  - Email notifications queued for both parties

- **Admin Security Alerts**: Comprehensive admin notification system for high-risk activities
  - Admins notified of disputed trades and suspicious activity
  - Security alerts for HIGH and CRITICAL risk events
  - Automatic notifications to all admin users
  - Notifications include risk level and direct links

- **Offer Event Notifications**: Complete offer notification system implemented
  - OFFER_APPROVED: Notifies when admin approves offer
  - OFFER_REJECTED: Notifies with rejection reason
  - OFFER_EXPIRED: Notifies when offer expires
  - OFFER_LOW_BALANCE: Warns about insufficient balance
  - OFFER_TRADE_INITIATED: Alerts when trade starts on offer

- **Reputation System Notifications**: Reputation event notifications implemented
  - REPUTATION_INCREASED/DECREASED: Notifies of reputation changes
  - MILESTONE_REACHED: Celebrates trade count milestones
  - POSITIVE_REVIEW/NEGATIVE_REVIEW: Alerts for reviews
  - TRUSTED_STATUS: Congratulates on trusted trader achievement
  - Different notification types based on event importance

- **Trade Initiation**: Verified trade initiation notifications working correctly
  - Offer owner receives in-app notification
  - Notification includes trade amount and currency
  - Email notification queued if enabled

- **Chat Messages**: Verified chat message notifications sent properly
  - Both parties receive notifications for new messages
  - Real-time notification delivery

## Backend Improvements

### Trade Timeout System

- **Offer-Specific Timeout**: Fixed timeout system to respect offer-specific payment window
  - Trades properly expire according to offer creator's timeout setting
  - No longer only uses global default payment window
  - Respects custom timeout periods (e.g., 15 minutes)

### Fee Calculation System

- **Maker/Taker Fee Assignment**: Completely refactored fee calculation
  - Maker = offer creator/owner (pays maker fee, typically 0.1%)
  - Taker = trade initiator/responder (pays taker fee, typically 0.2%)
  - Correctly uses offer owner and trade initiator IDs
  - No longer incorrectly assigns fees based on buy/sell direction

### Settings Management

- **Minimum Trade Amounts**: Fixed Fees & Limits settings page
  - Minimum trade amounts per currency can now be edited and saved
  - MinimumTradeAmounts and AutoReleaseEscrow settings properly loaded

### Database Compatibility

- **Offer Expiry Query**: Fixed MariaDB SQL syntax error in offer expiry handler
  - Changed from PostgreSQL JSON operators to MySQL-compatible functions
  - Proper JSON extraction for offer amount validation

### Frontend Assets

- **Missing Crypto Images**: Added missing FDUSD (First Digital USD) stablecoin image
  - Prevents unlimited error logs in Next.js
  - Complete crypto assets directory
